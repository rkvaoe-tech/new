#!/bin/bash

# –°–∫—Ä–∏–ø—Ç —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è Admin Panel –¥–ª—è CI/CD
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./deploy.sh [–ø—É—Ç—å_–∫_–∞—Ä—Ö–∏–≤—É]

set -e

ADMIN_DIR="/root/admin"
BACKUP_DIR="/root/admin-backup-$(date +%Y%m%d_%H%M%S)"
DEPLOY_USER="github-actions"

echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ Admin Panel..."
echo "üìÖ –í—Ä–µ–º—è: $(date)"
echo "üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: $(whoami)"

# –°–æ–∑–¥–∞–µ–º –±—ç–∫–∞–ø —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏
if [ -d "$ADMIN_DIR/.next" ]; then
    echo "üì¶ –°–æ–∑–¥–∞–µ–º –±—ç–∫–∞–ø —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏..."
    cp -r "$ADMIN_DIR/.next" "$BACKUP_DIR.next" 2>/dev/null || true
    echo "‚úÖ –ë—ç–∫–∞–ø —Å–æ–∑–¥–∞–Ω: $BACKUP_DIR.next"
fi

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º PM2
echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º PM2..."
pm2 stop admin-panel || true

# –ï—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω –∞—Ä—Ö–∏–≤, —Ä–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞–µ–º –µ–≥–æ
if [ "$1" ]; then
    echo "üì• –†–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞–µ–º –Ω–æ–≤—É—é —Å–±–æ—Ä–∫—É: $1"
    cd "$ADMIN_DIR"
    
    # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é —Å–±–æ—Ä–∫—É
    rm -rf .next 2>/dev/null || true
    
    # –†–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞–µ–º –Ω–æ–≤—É—é
    tar -xzf "$1"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Å–±–æ—Ä–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è
    if [ ! -f ".next/BUILD_ID" ]; then
        echo "‚ùå –û—à–∏–±–∫–∞: –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Å–±–æ—Ä–∫–∞ (–Ω–µ—Ç BUILD_ID)"
        exit 1
    fi
    
    echo "‚úÖ –°–±–æ—Ä–∫–∞ —Ä–∞—Å–ø–∞–∫–æ–≤–∞–Ω–∞, BUILD_ID: $(cat .next/BUILD_ID)"
fi

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ production –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º production –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
cd "$ADMIN_DIR"
npm ci --only=production --silent

# –ü—Ä–æ–≤–µ—Ä—è–µ–º middleware
if [ -f "src/middleware.ts" ]; then
    echo "üîß Middleware –Ω–∞–π–¥–µ–Ω –∏ –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω"
elif [ -f "src/middleware.ts.backup" ]; then
    echo "üîß –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º middleware –∏–∑ –±—ç–∫–∞–ø–∞..."
    mv src/middleware.ts.backup src/middleware.ts
fi

# –ó–∞–ø—É—Å–∫–∞–µ–º —á–µ—Ä–µ–∑ PM2
echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º —á–µ—Ä–µ–∑ PM2..."
pm2 start ecosystem.config.js

# –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
echo "‚è≥ –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
sleep 5

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
echo "üìä –°—Ç–∞—Ç—É—Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:"
pm2 list

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å
echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
if curl -f -s http://localhost:3000 >/dev/null; then
    echo "‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ localhost:3000"
else
    echo "‚ö†Ô∏è  –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ localhost:3000"
    pm2 logs admin-panel --lines 10
fi

echo "‚úÖ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
echo "üåê –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ –Ω–∞:"
echo "   - https://jliga.live"
echo "   - http://localhost:3000"
echo "üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–∞–º—è—Ç–∏:"
pm2 monit --no-colors | grep admin-panel | head -1 || echo "PM2 –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
