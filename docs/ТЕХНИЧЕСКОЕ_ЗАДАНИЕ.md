Техническое задание: админ-панель для карточек офферов

Цель

Создать единую страницу каталога офферов, доступную как пользователям, так и администраторам:
	•	пользователи видят карточки в режиме чтения;
	•	администраторы могут добавлять новые карточки, редактировать существующие и управлять лендингами/прелендингами прямо внутри карточки (inline-редактор).

⸻

Технологический стек
	•	Frontend: Next.js 14 (App Router), TypeScript
	•	UI: TailwindCSS + shadcn/ui, иконки Lucide
	•	State: React Query (TanStack)
	•	Backend: Next.js API Routes + Prisma + PostgreSQL
	•	Auth: NextAuth (JWT с ролью user | admin)
	•	Файлы: загрузка картинок в S3-совместимое хранилище через presigned URL

⸻

Роли и доступ
	•	User
Только просмотр. Нет кнопок редактирования, добавления и сортировки.
	•	Admin
Виден переключатель «Edit mode», кнопка «+ Add offer», иконки редактирования. Может добавлять, изменять, удалять офферы, лендинги и прелендинги.


Доменная модель
// Оффер
export interface Offer {
  id: string;
  vertical: string;            // Напр. "Male Enhancement"
  title: string;               // Название бренда, напр. "Proliving"
  priceUsd: number;            // Цена, напр. 44
  geo: string[];               // Список GEO (["US"])
  tags: string[];              // ["SS","NEW"]
  status: "active"|"paused"|"archived";
  imageUrl: string;
  order: number;
  createdAt: Date;
  updatedAt: Date;
  landings: Landing[];
  prelandings: Landing[];
}

// Лендинг/Преленд
export interface Landing {
  id: string;
  extId?: number;              // Внешний ID (напр. 188, 274)
  label: string;               // Название (Default, Reddit quiz)
  type: "landing" | "prelanding";
  locale: string;              // Язык (EN, ES, JB и т.д.)
  networkCode?: string;        // Код партнёрки (JL, EL, ER…)
  url: string;
  notes?: string;
  order: number;
}


Prisma-схема

model Offer {
  id          String   @id @default(uuid())
  vertical    String
  title       String
  priceUsd    Int
  geo         String[]
  tags        String[]
  status      String
  imageUrl    String
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  landings    Landing[] @relation("OfferToLanding")
}

model Landing {
  id          String   @id @default(uuid())
  extId       Int?
  label       String
  type        String
  locale      String
  networkCode String?
  url         String
  notes       String?
  order       Int      @default(0)
  offerId     String
  offer       Offer    @relation("OfferToLanding", fields: [offerId], references: [id])

  @@index([networkCode])
}

API
	•	GET /api/offers?search=&status=&geo=&tag=&locale=&partner= — список офферов
	•	POST /api/offers — создать пустую карточку
	•	PATCH /api/offers/:id — частичное обновление
	•	DELETE /api/offers/:id — удалить
	•	POST /api/offers/:id/image — загрузка обложки
	•	POST /api/offers/:id/landings — добавить лендинг/прелендинг
	•	PATCH /api/landings/:id — редактировать лендинг
	•	DELETE /api/landings/:id — удалить лендинг
	•	POST /api/offers/reorder / POST /api/landings/reorder — drag-sort

Все ответы в JSON, ошибки в формате application/problem+json.

⸻

UI/UX

Главная страница
	•	Toolbar: поиск, фильтры по Status, GEO, Tag, Locale, Partner
	•	Grid карточек (адаптивная сетка)
	•	Для admin: кнопка «+ Add offer» + переключатель «Edit mode»

Карточка оффера
	•	Заголовок: теги (SS, NEW), статус (Active, Paused), цена $
	•	Обложка (1:1), вертикаль, бренд, GEO бейджи
	•	Аккордеоны: «Лендинги» и «Прелендинги»
	•	Элемент списка: extId, label, locale (серый бейдж), partner (жёлтый бейдж), ссылка
	•	Для admin:
	•	Карандаш → inline редактирование
	•	Кнопки: Toggle Active, Duplicate, Delete
	•	Добавление лендинга внутри секции
	•	Drag-sort офферов и лендингов

Добавление пустой карточки

При нажатии «+ Add offer» появляется пустая карточка:

{
  "title": "Untitled",
  "vertical": "Undefined",
  "priceUsd": 0,
  "geo": [],
  "tags": [],
  "status": "paused",
  "imageUrl": "",
  "landings": [],
  "prelandings": []
}

Валидации
	•	title, vertical обязательны
	•	priceUsd >= 0
	•	url начинается с https://
	•	locale — ISO код языка
	•	networkCode — 2–6 латинских символов, верхний регистр
	•	Уникальность extId внутри одного оффера

⸻

Справочники
	•	GEO: ISO-коды стран
	•	Locale: EN, ES, JB, FR и т.д.
	•	Partner (networkCode): JL, EL, ER, TS и т.п.

⸻

Аудит
	•	Логирование действий admin: actorId, action, entity, entityId, diff, at
	•	История изменений доступна в боковой панели «History» у admin

⸻

Тест-кейсы приёмки
	1.	User видит карточки, не имеет кнопок редактирования
	2.	Admin добавляет оффер → появляется пустая карточка в режиме редактирования
	3.	Admin меняет статус, цену, картинку → изменения видны всем без перезагрузки
	4.	Добавление лендинга с некорректным URL блокируется
	5.	Drag-sort сохраняет порядок
	6.	Фильтры работают по статусу, GEO, тегам, локали, партнёрке
	7.	Все действия admin логируются

⸻

Производительность
	•	Серверная пагинация + infinite scroll
	•	Индексация по status, geo, tags, networkCode
	•	Оптимизация картинок (Next/Image)

⸻

Локализация
	•	i18n для интерфейса панели
	•	Поддержка разных locale у лендингов

⸻

Быстрый старт (Cursor)
	1.	npx create-next-app + Tailwind + shadcn/ui
	2.	Настроить Prisma, сгенерировать схемы
	3.	Реализовать API routes + Zod валидации
	4.	Подключить NextAuth с ролями
	5.	Сделать компоненты: OfferCard, LandingList, Toolbar
	6.	Реализовать загрузку изображений (S3 presigned)


Ниже структура БД (PostgreSQL) и seed.sql. Достаточно выполнить в psql по очереди.

-- schema.sql
-- PostgreSQL 14+
CREATE EXTENSION IF NOT EXISTS "pgcrypto"; -- для gen_random_uuid()

-- Доменные типы и простые проверки
CREATE TYPE offer_status AS ENUM ('active','paused','archived');

-- Таблица пользователей (для ролей и аудита)
CREATE TABLE app_user (
  id          UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  email       CITEXT UNIQUE NOT NULL,
  display_name TEXT NOT NULL,
  role        TEXT NOT NULL CHECK (role IN ('user','admin')),
  created_at  TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- Офферы
CREATE TABLE offer (
  id          UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  vertical    TEXT NOT NULL,
  title       TEXT NOT NULL,
  price_usd   INTEGER NOT NULL CHECK (price_usd >= 0),
  geo         TEXT[] NOT NULL DEFAULT '{}',              -- ISO-коды стран
  tags        TEXT[] NOT NULL DEFAULT '{}',
  status      offer_status NOT NULL DEFAULT 'paused',
  image_url   TEXT NOT NULL DEFAULT '',
  ord         INTEGER NOT NULL DEFAULT 0,                -- позиция в списке
  created_at  TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at  TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE INDEX ix_offer_status ON offer (status);
CREATE INDEX ix_offer_ord     ON offer (ord);
CREATE INDEX ix_offer_geo_gin ON offer USING GIN (geo);
CREATE INDEX ix_offer_tags_gin ON offer USING GIN (tags);

-- Лендинги / прелендинги
CREATE TABLE landing (
  id           UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  offer_id     UUID NOT NULL REFERENCES offer(id) ON DELETE CASCADE,
  ext_id       INTEGER,                                   -- внешний ID (188, 274…)
  label        TEXT NOT NULL,                             -- "Default", "Reddit quiz"
  type         TEXT NOT NULL CHECK (type IN ('landing','prelanding')),
  locale       TEXT NOT NULL CHECK (char_length(locale) BETWEEN 2 AND 6),
  network_code TEXT CHECK (network_code ~ '^[A-Z0-9]{2,6}$'), -- JL, EL, ER…
  url          TEXT NOT NULL CHECK (url LIKE 'https://%'),
  notes        TEXT,
  ord          INTEGER NOT NULL DEFAULT 0,                -- позиция внутри секции
  created_at   TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at   TIMESTAMPTZ NOT NULL DEFAULT now(),

  -- Уникальность ext_id внутри одного оффера и типа
  CONSTRAINT uq_landing_ext_per_offer UNIQUE (offer_id, type, ext_id)
);

CREATE INDEX ix_landing_offer_type_ord ON landing (offer_id, type, ord);
CREATE INDEX ix_landing_network_code   ON landing (network_code);
CREATE INDEX ix_landing_locale         ON landing (locale);

-- Аудит
CREATE TABLE audit_log (
  id         UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  actor_id   UUID REFERENCES app_user(id) ON DELETE SET NULL,
  action     TEXT NOT NULL,                                 -- create|update|delete
  entity     TEXT NOT NULL,                                 -- offer|landing
  entity_id  UUID NOT NULL,
  diff       JSONB NOT NULL,                                -- {before, after}
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE INDEX ix_audit_created ON audit_log (created_at DESC);

-- Триггеры updated_at
CREATE OR REPLACE FUNCTION set_updated_at()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at := now();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_offer_updated
BEFORE UPDATE ON offer
FOR EACH ROW EXECUTE FUNCTION set_updated_at();

CREATE TRIGGER trg_landing_updated
BEFORE UPDATE ON landing
FOR EACH ROW EXECUTE FUNCTION set_updated_at();



-- seed.sql

-- Админы/юзеры
INSERT INTO app_user (email, display_name, role) VALUES
  ('admin@example.com','Admin','admin'),
  ('user@example.com','Viewer','user')
ON CONFLICT (email) DO NOTHING;

-- Оффер из примера (Proliving)
WITH ins AS (
  INSERT INTO offer (vertical, title, price_usd, geo, tags, status, image_url, ord)
  VALUES ('Male Enhancement','Proliving',44, ARRAY['US'], ARRAY['SS','NEW'], 'active',
          'https://cdn.example.com/offers/proliving.png', 10)
  RETURNING id
)
-- Лендинги
INSERT INTO landing (offer_id, ext_id, label, type, locale, network_code, url, ord)
SELECT id, 188, 'Default', 'landing', 'EN', 'JL', 'https://example.com/landing/188', 1 FROM ins;

-- Прелендинги
WITH off AS (SELECT id FROM offer WHERE title='Proliving' LIMIT 1)
INSERT INTO landing (offer_id, ext_id, label, type, locale, network_code, url, ord) VALUES
  ((SELECT id FROM off), 274, 'Reddit barbara + quiz', 'prelanding', 'ES', 'JL', 'https://example.com/pre/274', 1),
  ((SELECT id FROM off), 275, 'Reddit barbara + quiz', 'prelanding', 'EN', 'JL', 'https://example.com/pre/275', 2);

-- Дополнительные офферы для наполнения
INSERT INTO offer (vertical, title, price_usd, geo, tags, status, image_url, ord) VALUES
  ('Male Enhancement','Titan Surge',149, ARRAY['US','CA'], ARRAY['CPS','Private'], 'paused',
   'https://cdn.example.com/offers/titan-surge.png', 20),
  ('Health','Vydox',69, ARRAY['US'], ARRAY['CPS'], 'active',
   'https://cdn.example.com/offers/vydox.png', 30);

-- Лендинги для Titan Surge
WITH o AS (SELECT id FROM offer WHERE title='Titan Surge' LIMIT 1)
INSERT INTO landing (offer_id, ext_id, label, type, locale, network_code, url, ord) VALUES
  ((SELECT id FROM o), 501, 'Default', 'landing', 'EN', 'EL', 'https://example.com/ts/landing/501', 1),
  ((SELECT id FROM o), 901, 'Quiz v2', 'prelanding', 'EN', 'EL', 'https://example.com/ts/pre/901', 1);

-- Лендинги для Vydox
WITH o AS (SELECT id FROM offer WHERE title='Vydox' LIMIT 1)
INSERT INTO landing (offer_id, ext_id, label, type, locale, network_code, url, ord) VALUES
  ((SELECT id FROM o), 310, 'Default', 'landing', 'EN', 'ER', 'https://example.com/vy/landing/310', 1);


  psql "$DATABASE_URL" -f schema.sql
psql "$DATABASE_URL" -f seed.sql